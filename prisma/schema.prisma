// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    // NOTE: When using postgresql, mysql or sqlserver, uncomment the @db.Text annotations in model Account below
    // Further reading:
    // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
    // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
    url      = env("DATABASE_URL")
}

model Example {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Necessary for Next auth
model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? // @db.Text
    access_token      String? // @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? // @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    factoryId     String?   @unique
    Accounts      Account[]
    Sessions      Session[]
    Factory       Factory?  @relation(fields: [factoryId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

model Factory {
    id                String             @id @default(cuid())
    name              String
    User              User?
    Tanks             Tank[]
    Blends            Blend[]
    BlendComponents   BlendComponent[]
    Formulas          Formula[]
    FormulaComponents FormulaComponent[]
    Products          Product[]
    ProductCodes      ProductCode[]
    ProductBases      ProductBase[]
    ProductSizes      ProductSize[]
    ProductVariants   ProductVariant[]
    Customers         Customer[]
    SalesOrders       SalesOrder[]
    SalesOrderItems   SalesOrderItem[]
}

// Product Models

model ProductBase {
    factoryId    String
    code         Int /// 3-digit. First digit indicates general product type.
    name         String
    description  String
    Factory      Factory       @relation(fields: [factoryId], references: [id])
    ProductCodes ProductCode[]

    @@id([factoryId, code])
}

model ProductSize {
    factoryId    String
    code         Int /// e.g., 0 = "N/A"; 1 = "bulk"; 5 = "pail"; 55 = "drum"; 275 = "275 Gal. Tote"; 330 = "330 Gal. Tote"
    name         String
    description  String
    Factory      Factory       @relation(fields: [factoryId], references: [id])
    ProductCodes ProductCode[]

    @@id([factoryId, code])
}

/// Used for determining customer-specific requirements for labeling (and other packaging details), formulation details, etc.
model ProductVariant {
    factoryId    String
    code         Int /// e.g., 0 = "N/A"; 1 = "Store Brand"
    name         String
    description  String
    Factory      Factory       @relation(fields: [factoryId], references: [id])
    ProductCodes ProductCode[]

    @@id([factoryId, code])
}

model ProductCode {
    factoryId      String
    baseCode       Int
    sizeCode       Int
    variantCode    Int
    Factory        Factory        @relation(fields: [factoryId], references: [id])
    ProductBase    ProductBase    @relation(fields: [baseCode, factoryId], references: [code, factoryId])
    ProductSize    ProductSize    @relation(fields: [sizeCode, factoryId], references: [code, factoryId])
    ProductVariant ProductVariant @relation(fields: [variantCode, factoryId], references: [code, factoryId])
    Product        Product?

    @@id([factoryId, baseCode, sizeCode, variantCode])
}

model Product {
    factoryId         String
    baseCode          Int
    sizeCode          Int
    variantCode       Int
    description       String             @default("")
    quantityInStock   Decimal            @default(0)
    salesPrice        Decimal?
    Factory           Factory            @relation(fields: [factoryId], references: [id])
    Code              ProductCode        @relation(fields: [factoryId, baseCode, sizeCode, variantCode], references: [factoryId, baseCode, sizeCode, variantCode])
    SalesOrderItems   SalesOrderItem[]
    SourceTanks       Tank[]
    Formulas          Formula[]
    FormulaComponents FormulaComponent[]

    @@id([factoryId, baseCode, sizeCode, variantCode])
}

// Tank Models

model Tank {
    factoryId              String
    name                   String /// Matches pattern /[A-Z]{1,2}\-\d{2}/ e.g., A-01 for Storage Tank or BL-01 for Blend Tank
    baseCode               Int
    sizeCode               Int              @default(1) /// Defaults to sizeCode for Bulk products
    variantCode            Int              @default(0) /// Defaults to variantCode for Unbranded products
    quantity               Decimal          @default(0) /// Defaults to empty
    capacity               Decimal
    heel                   Decimal
    isDefaultSource        Boolean          @default(false)
    Factory                Factory          @relation(fields: [factoryId], references: [id])
    Product                Product          @relation(fields: [factoryId, baseCode, sizeCode, variantCode], references: [factoryId, baseCode, sizeCode, variantCode])
    BlendsDestined         Blend[]          @relation(name: "Destination Tank")
    BlendsBlended          Blend[]          @relation(name: "Blend Tank")
    BlendComponentsSourced BlendComponent[]

    @@id([name, factoryId])
}

// Blend Models

model Blend {
    id                  String           @id @default(cuid())
    factoryId           String
    formulaId           String
    targetQuantity      Decimal
    actualQuantity      Decimal?
    blendTankName       String?
    destinationTankName String?
    note                String?
    status              String           @default("CREATED") /// Valid values: CREATED, QUEUED, ASSEMBLING, BLENDING, TESTING, ADJUSTING, PASSED, PUSHED, FLAGGED, COMPLETE
    Factory             Factory          @relation(fields: [factoryId], references: [id])
    Formula             Formula          @relation(fields: [formulaId], references: [id])
    Components          BlendComponent[]
    BlendTank           Tank?            @relation(fields: [blendTankName, factoryId], references: [name, factoryId], name: "Blend Tank")
    DestinationTank     Tank?            @relation(fields: [destinationTankName, factoryId], references: [name, factoryId], name: "Destination Tank")
}

model BlendComponent {
    factoryId          String
    blendId            String
    formulaComponentId String
    sourceTankName     String
    targetQuantity     Decimal
    actualQuantity     Decimal?
    note               String?
    Factory            Factory          @relation(fields: [factoryId], references: [id])
    Blend              Blend            @relation(fields: [blendId], references: [id])
    FormulaComponent   FormulaComponent @relation(fields: [formulaComponentId], references: [id])
    SourceTank         Tank             @relation(fields: [sourceTankName, factoryId], references: [name, factoryId])

    @@unique([formulaComponentId, blendId])
}

model Formula {
    id          String             @id @default(cuid())
    factoryId   String
    baseCode    Int
    sizeCode    Int                @default(1)
    variantCode Int                @default(0)
    Factory     Factory            @relation(fields: [factoryId], references: [id])
    Product     Product            @relation(fields: [baseCode, sizeCode, variantCode, factoryId], references: [baseCode, sizeCode, variantCode, factoryId])
    Blends      Blend[]
    Components  FormulaComponent[]
}

model FormulaComponent {
    id              String           @id @default(cuid())
    factoryId       String
    formulaId       String
    baseCode        Int
    sizeCode        Int              @default(1)
    variantCode     Int              @default(0)
    proportion      Decimal
    note            String?
    Factory         Factory          @relation(fields: [factoryId], references: [id])
    Formula         Formula          @relation(fields: [formulaId], references: [id])
    Product         Product          @relation(fields: [baseCode, sizeCode, variantCode, factoryId], references: [baseCode, sizeCode, variantCode, factoryId])
    BlendComponents BlendComponent[]
}

// Order Models

model Customer {
    id                       Int          @id @default(autoincrement())
    factoryId                String
    name                     String       @unique
    defaultBillingAddressId  String?      @unique
    defaultShippingAddressId String?      @unique
    Factory                  Factory      @relation(fields: [factoryId], references: [id])
    DefaultBillingAddress    Address?     @relation(name: "Default Billing", fields: [defaultBillingAddressId], references: [id])
    DefaultShippingAddress   Address?     @relation(name: "Default Shipping", fields: [defaultShippingAddressId], references: [id])
    Addresses                Address[]
    Orders                   SalesOrder[]
}

model Address {
    id                 String    @id @default(cuid())
    street             String
    city               String
    state              String
    zip                String
    customerId         Int
    Customer           Customer  @relation(fields: [customerId], references: [id])
    DefaultBillingFor  Customer? @relation(name: "Default Billing")
    DefaultShippingFor Customer? @relation(name: "Default Shipping")
}

model SalesOrderItem {
    id           String     @id @default(cuid())
    factoryId    String
    orderId      Int
    baseCode     Int
    sizeCode     Int
    variantCode  Int
    quantity     Decimal
    pricePerUnit Decimal
    notes        String?
    Factory      Factory    @relation(fields: [factoryId], references: [id])
    Order        SalesOrder @relation(fields: [orderId], references: [id])
    Product      Product    @relation(fields: [baseCode, sizeCode, variantCode, factoryId], references: [baseCode, sizeCode, variantCode, factoryId])
}

model SalesOrder {
    id              Int              @id @default(autoincrement())
    factoryId       String
    customerId      Int
    notes           String?
    orderedOn       DateTime         @default(now())
    readyOn         DateTime?
    shippedOn       DateTime?
    deliveredOn     DateTime?
    readyTarget     DateTime?
    shippedTarget   DateTime?
    deliveredTarget DateTime?
    Factory         Factory          @relation(fields: [factoryId], references: [id])
    Customer        Customer         @relation(fields: [customerId], references: [id])
    Items           SalesOrderItem[]
}
